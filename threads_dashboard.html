<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Threads Reply Analysis Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .wordcloud-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 30px;
        }

        .wordcloud-wrapper {
            height: 500px;
            position: relative;
            background: radial-gradient(circle at center, #f8fafc, #e2e8f0);
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wordcloud-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .control-btn.active {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .data-viewer-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-top: 30px;
        }

        .data-viewer-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .data-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .data-controls-left {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .data-controls-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-input, .search-input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus, .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .data-table-container {
            max-height: 500px;
            overflow: auto;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #fff;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-table tr:hover {
            background-color: #f8fafc;
        }

        .data-table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .sentiment-positive {
            background-color: #dcfce7 !important;
            color: #166534;
            font-weight: 600;
        }
        .sentiment-negative {
            background-color: #fee2e2 !important;
            color: #991b1b;
            font-weight: 600;
        }
        .sentiment-neutral {
            background-color: #f3f4f6 !important;
            color: #374151;
            font-weight: 600;
        }

        .confidence-high { color: #059669; font-weight: 600; }
        .confidence-medium { color: #d97706; font-weight: 600; }
        .confidence-low { color: #dc2626; font-weight: 600; }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .pagination button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .export-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .text-preview {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .text-preview:hover {
            background-color: #e0f2fe !important;
        }

        .text-full {
            display: none;
            max-width: 400px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #666;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2rem;
            }
            .data-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .data-table {
                font-size: 11px;
            }
            .data-table th, .data-table td {
                padding: 6px 4px;
                max-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Advanced Threads Reply Analysis Dashboard</h1>
            <p>Comprehensive sentiment analysis with advanced visualizations and data exploration</p>
            <div style="margin-top: 20px;">
                <input type="file" id="fileInput" accept=".csv" style="display: none;">
                <button onclick="document.getElementById('fileInput').click()" style="
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 25px;
                    font-size: 1rem;
                    cursor: pointer;
                    transition: transform 0.3s ease;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    Select CSV File
                </button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            Loading and analyzing data...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="stats-grid" id="statsGrid"></div>

            <div class="wordcloud-container full-width">
                <div class="chart-title">Interactive Word Cloud</div>
                <div class="wordcloud-controls">
                    <button class="control-btn active" onclick="updateWordCloud('all')">All Words</button>
                    <button class="control-btn" onclick="updateWordCloud('positive')">Positive Replies</button>
                    <button class="control-btn" onclick="updateWordCloud('negative')">Negative Replies</button>
                    <button class="control-btn" onclick="updateWordCloud('neutral')">Neutral Replies</button>
                </div>
                <div class="wordcloud-wrapper">
                    <canvas id="wordcloud" width="1200" height="500"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Sentiment Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Sentiment Score Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="sentimentScoreChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Reply Length Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="lengthChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Reply Activity by Hour</div>
                    <div class="chart-wrapper">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Confidence Levels</div>
                    <div class="chart-wrapper">
                        <canvas id="confidenceChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Emoji Usage by Sentiment</div>
                    <div class="chart-wrapper">
                        <canvas id="emojiChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container full-width">
                <div class="chart-title">Sentiment Over Time</div>
                <div class="chart-wrapper" style="height: 500px;">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <div class="data-viewer-section">
                <h2 class="data-viewer-title">Raw Data Viewer</h2>

                <div class="data-controls">
                    <div class="data-controls-left">
                        <input type="text" id="searchInput" class="search-input" placeholder="Search text content..." onkeyup="filterTable()">
                        <select id="sentimentFilter" class="filter-input" onchange="filterTable()">
                            <option value="">All Sentiments</option>
                            <option value="positive">Positive</option>
                            <option value="negative">Negative</option>
                            <option value="neutral">Neutral</option>
                        </select>
                        <select id="confidenceFilter" class="filter-input" onchange="filterTable()">
                            <option value="">All Confidence</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="data-controls-right">
                        <button class="export-btn" onclick="exportFilteredData()">Export Filtered</button>
                        <span id="filteredCount">0 rows</span>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th style="width: 60px;">Row</th>
                                <th style="width: 100px;">Username</th>
                                <th style="width: 300px;">Text Content</th>
                                <th style="width: 100px;">Sentiment</th>
                                <th style="width: 80px;">Score</th>
                                <th style="width: 80px;">Confidence</th>
                                <th style="width: 60px;">Words</th>
                                <th style="width: 60px;">Emojis</th>
                                <th style="width: 120px;">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>

                <div class="pagination">
                    <button id="prevPageBtn" onclick="changePage(-1)" disabled>← Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button id="nextPageBtn" onclick="changePage(1)">Next →</button>
                    <select id="rowsPerPage" onchange="updateRowsPerPage()" style="margin-left: 20px; padding: 5px;">
                        <option value="25">25 rows</option>
                        <option value="50" selected>50 rows</option>
                        <option value="100">100 rows</option>
                        <option value="all">All rows</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let wordFrequency = {};
        let currentWordCloudFilter = 'all';
        let filteredData = [];
        let currentPage = 1;
        let rowsPerPageValue = 50;

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const parsed = Papa.parse(csvContent, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });

                    data = parsed.data.filter(row => row.text && row.text.trim());

                    if (data.length === 0) {
                        throw new Error('No valid data found in CSV file');
                    }

                    console.log(`Loaded ${data.length} replies`);
                    processWordFrequency();

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';

                    generateStats();
                    generateSentimentChart();
                    generateSentimentScoreChart();
                    generateLengthChart();
                    generateHourlyChart();
                    generateConfidenceChart();
                    generateEmojiChart();
                    generateTimelineChart();
                    createWordCloud();
                    populateDataTable();

                } catch (error) {
                    console.error('Error processing file:', error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').textContent = `Error processing file: ${error.message}`;
                }
            };
            reader.readAsText(file);
        }

        async function loadAndAnalyzeData() {
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            try {
                const fileContent = await window.fs.readFile('threads_comments_full_analyzed.csv', { encoding: 'utf8' });

                const parsed = Papa.parse(fileContent, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true
                });

                data = parsed.data.filter(row => row.text && row.text.trim());

                if (data.length === 0) {
                    throw new Error('No valid data found in CSV file');
                }

                console.log(`Auto-loaded ${data.length} replies`);
                processWordFrequency();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

                generateStats();
                generateSentimentChart();
                generateSentimentScoreChart();
                generateLengthChart();
                generateHourlyChart();
                generateConfidenceChart();
                generateEmojiChart();
                generateTimelineChart();
                createWordCloud();
                populateDataTable();

            } catch (error) {
                console.log('Auto-load failed, showing file picker');
                document.getElementById('loading').style.display = 'none';
            }
        }

        function processWordFrequency() {
            wordFrequency = {
                all: {},
                positive: {},
                negative: {},
                neutral: {}
            };

            const stopWords = new Set([
                'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for',
                'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have',
                'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should',
                'i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us',
                'them', 'my', 'your', 'his', 'its', 'our', 'their', 'this', 'that',
                'these', 'those', 'am', 'if', 'so', 'no', 'not', 'can', 'get', 'just'
            ]);

            data.forEach(row => {
                if (!row.cleaned_text) return;

                const words = row.cleaned_text.toLowerCase()
                    .replace(/[^\w\s]/g, ' ')
                    .split(/\s+/)
                    .filter(word => word.length > 2 && !stopWords.has(word));

                const sentiment = row.final_sentiment || 'neutral';

                words.forEach(word => {
                    wordFrequency.all[word] = (wordFrequency.all[word] || 0) + 1;
                    wordFrequency[sentiment][word] = (wordFrequency[sentiment][word] || 0) + 1;
                });
            });
        }

        function createWordCloud() {
            updateWordCloud('all');
        }

        function updateWordCloud(filter) {
            currentWordCloudFilter = filter;

            document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
            const buttons = document.querySelectorAll('.control-btn');
            buttons.forEach(btn => {
                if ((filter === 'all' && btn.textContent.includes('All')) ||
                    btn.textContent.toLowerCase().includes(filter)) {
                    btn.classList.add('active');
                }
            });

            const canvas = document.getElementById('wordcloud');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const words = wordFrequency[filter] || {};
            const wordList = Object.entries(words)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 100)
                .map(([word, count]) => [word, count]);

            if (wordList.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No words found for this filter', canvas.width/2, canvas.height/2);
                return;
            }

            WordCloud(canvas, {
                list: wordList,
                gridSize: Math.round(8 * canvas.width / 1200),
                weightFactor: function (size) {
                    const maxCount = Math.max(...wordList.map(([,count]) => count));
                    const minCount = Math.min(...wordList.map(([,count]) => count));
                    const normalizedSize = (size - minCount) / (maxCount - minCount);
                    return (12 + normalizedSize * 48) * (canvas.width / 1200);
                },
                fontFamily: 'Arial, sans-serif',
                color: function (word, weight, fontSize, distance, theta) {
                    const colors = {
                        all: ['#667eea', '#764ba2', '#f093fb', '#f5576c'],
                        positive: ['#22c55e', '#16a34a', '#15803d', '#166534'],
                        negative: ['#ef4444', '#dc2626', '#b91c1c', '#991b1b'],
                        neutral: ['#9ca3af', '#6b7280', '#4b5563', '#374151']
                    };
                    const colorSet = colors[filter] || colors.all;
                    return colorSet[Math.floor(Math.random() * colorSet.length)];
                },
                rotateRatio: 0.2,
                backgroundColor: 'transparent',
                drawOutOfBound: false,
                shrinkToFit: true,
                minSize: 12,
                maxSize: 60
            });
        }

        function generateStats() {
            const totalReplies = data.length;
            const uniqueUsers = new Set(data.map(d => d.username)).size;
            const avgWordCount = (data.reduce((sum, d) => sum + (d.word_count || 0), 0) / totalReplies).toFixed(1);
            const avgSentimentScore = (data.reduce((sum, d) => sum + Math.abs(d.combined_sentiment_score || 0), 0) / totalReplies).toFixed(3);
            const emojiUsage = ((data.filter(d => (d.emoji_count || 0) > 0).length / totalReplies) * 100).toFixed(1);
            const engagementRate = ((data.filter(d => d.has_question || d.has_exclamation).length / totalReplies) * 100).toFixed(1);

            const stats = [
                { number: totalReplies.toLocaleString(), label: 'Total Replies' },
                { number: uniqueUsers.toLocaleString(), label: 'Unique Users' },
                { number: avgWordCount, label: 'Avg Words/Reply' },
                { number: avgSentimentScore, label: 'Avg Sentiment Score' },
                { number: `${emojiUsage}%`, label: 'Emoji Usage' },
                { number: `${engagementRate}%`, label: 'Engagement Rate' }
            ];

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="stat-number">${stat.number}</div>
                    <div class="stat-label">${stat.label}</div>
                </div>
            `).join('');
        }

        function generateSentimentChart() {
            const sentimentCounts = {};
            data.forEach(d => {
                const sentiment = d.final_sentiment || 'neutral';
                sentimentCounts[sentiment] = (sentimentCounts[sentiment] || 0) + 1;
            });

            const ctx = document.getElementById('sentimentChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(sentimentCounts),
                    datasets: [{
                        data: Object.values(sentimentCounts),
                        backgroundColor: ['#ff6b6b', '#95a5a6', '#4ecdc4'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function generateSentimentScoreChart() {
            const scores = data.map(d => d.combined_sentiment_score || 0);
            const bins = 20;
            const min = Math.min(...scores);
            const max = Math.max(...scores);
            const binWidth = (max - min) / bins;

            const histogram = new Array(bins).fill(0);
            const labels = [];

            for (let i = 0; i < bins; i++) {
                const binStart = min + i * binWidth;
                const binEnd = binStart + binWidth;
                labels.push(binStart.toFixed(2));

                scores.forEach(score => {
                    if (score >= binStart && (score < binEnd || (i === bins - 1 && score === binEnd))) {
                        histogram[i]++;
                    }
                });
            }

            const ctx = document.getElementById('sentimentScoreChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frequency',
                        data: histogram,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Sentiment Score' } },
                        y: { title: { display: true, text: 'Frequency' } }
                    }
                }
            });
        }

        function generateLengthChart() {
            const lengths = data.map(d => d.word_count || 0);
            const maxLength = Math.max(...lengths);
            const binSize = Math.max(1, Math.ceil(maxLength / 15));
            const bins = Math.ceil(maxLength / binSize);

            const histogram = new Array(bins).fill(0);
            const labels = [];

            for (let i = 0; i < bins; i++) {
                const binStart = i * binSize;
                const binEnd = binStart + binSize;
                labels.push(`${binStart}-${binEnd}`);

                lengths.forEach(length => {
                    if (length >= binStart && length < binEnd) {
                        histogram[i]++;
                    }
                });
            }

            const ctx = document.getElementById('lengthChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Replies',
                        data: histogram,
                        backgroundColor: 'rgba(76, 175, 80, 0.7)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Word Count Range' } },
                        y: { title: { display: true, text: 'Number of Replies' } }
                    }
                }
            });
        }

        function generateHourlyChart() {
            const hourCounts = new Array(24).fill(0);
            const hourlySentiment = Array(24).fill(null).map(() => ({positive: 0, neutral: 0, negative: 0}));

            data.forEach(d => {
                if (d.hour !== null && d.hour !== undefined) {
                    const hour = parseInt(d.hour);
                    if (hour >= 0 && hour < 24) {
                        hourCounts[hour]++;
                        const sentiment = d.final_sentiment || 'neutral';
                        hourlySentiment[hour][sentiment]++;
                    }
                }
            });

            const ctx = document.getElementById('hourlyChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [
                        {
                            label: 'Total Replies',
                            data: hourCounts,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Positive',
                            data: hourlySentiment.map(h => h.positive),
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Negative',
                            data: hourlySentiment.map(h => h.negative),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        x: { title: { display: true, text: 'Hour of Day' } },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Replies' }
                        }
                    }
                }
            });
        }

        function generateConfidenceChart() {
            const confidenceData = {
                high: { positive: 0, neutral: 0, negative: 0 },
                medium: { positive: 0, neutral: 0, negative: 0 },
                low: { positive: 0, neutral: 0, negative: 0 }
            };

            data.forEach(row => {
                const conf = row.confidence || 'low';
                const sent = row.final_sentiment || 'neutral';
                if (confidenceData[conf] && confidenceData[conf].hasOwnProperty(sent)) {
                    confidenceData[conf][sent]++;
                }
            });

            const ctx = document.getElementById('confidenceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [
                        {
                            label: 'Positive',
                            data: [confidenceData.high.positive, confidenceData.medium.positive, confidenceData.low.positive],
                            backgroundColor: '#22c55e'
                        },
                        {
                            label: 'Neutral',
                            data: [confidenceData.high.neutral, confidenceData.medium.neutral, confidenceData.low.neutral],
                            backgroundColor: '#9ca3af'
                        },
                        {
                            label: 'Negative',
                            data: [confidenceData.high.negative, confidenceData.medium.negative, confidenceData.low.negative],
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        x: { title: { display: true, text: 'Confidence Level' } },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Replies' }
                        }
                    }
                }
            });
        }

        function generateEmojiChart() {
            const sentimentEmoji = {
                positive: 0,
                neutral: 0,
                negative: 0
            };

            data.forEach(d => {
                const sentiment = d.final_sentiment || 'neutral';
                if ((d.emoji_count || 0) > 0) {
                    sentimentEmoji[sentiment]++;
                }
            });

            const ctx = document.getElementById('emojiChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        label: 'Replies with Emojis',
                        data: [sentimentEmoji.positive, sentimentEmoji.neutral, sentimentEmoji.negative],
                        backgroundColor: ['#4ecdc4', '#95a5a6', '#ff6b6b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Replies' }
                        }
                    }
                }
            });
        }

        function generateTimelineChart() {
            const timelineData = {};
            data.forEach(row => {
                if (row.timestamp) {
                    const date = new Date(row.timestamp).toDateString();
                    if (!timelineData[date]) {
                        timelineData[date] = { positive: 0, neutral: 0, negative: 0, total: 0 };
                    }
                    const sentiment = row.final_sentiment || 'neutral';
                    timelineData[date][sentiment]++;
                    timelineData[date].total++;
                }
            });

            const sortedDates = Object.keys(timelineData).sort((a, b) => new Date(a) - new Date(b));
            const positiveData = sortedDates.map(date => (timelineData[date].positive / timelineData[date].total * 100));
            const negativeData = sortedDates.map(date => (timelineData[date].negative / timelineData[date].total * 100));
            const neutralData = sortedDates.map(date => (timelineData[date].neutral / timelineData[date].total * 100));

            const ctx = document.getElementById('timelineChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(date => new Date(date).toLocaleDateString()),
                    datasets: [
                        {
                            label: 'Positive %',
                            data: positiveData,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Negative %',
                            data: negativeData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Neutral %',
                            data: neutralData,
                            borderColor: '#9ca3af',
                            backgroundColor: 'rgba(156, 163, 175, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Percentage' }
                        },
                        x: { title: { display: true, text: 'Date' } }
                    }
                }
            });
        }

        function populateDataTable() {
            filteredData = [...data];
            currentPage = 1;
            updateTable();
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sentimentFilter = document.getElementById('sentimentFilter').value;
            const confidenceFilter = document.getElementById('confidenceFilter').value;

            filteredData = data.filter(row => {
                const matchesSearch = !searchTerm || (row.text || '').toLowerCase().includes(searchTerm);
                const matchesSentiment = !sentimentFilter || (row.final_sentiment || 'neutral') === sentimentFilter;
                const matchesConfidence = !confidenceFilter || (row.confidence || 'low') === confidenceFilter;

                return matchesSearch && matchesSentiment && matchesConfidence;
            });

            currentPage = 1;
            updateTable();
        }

        function updateTable() {
            const tbody = document.getElementById('dataTableBody');
            const rowsPerPage = rowsPerPageValue === 'all' ? filteredData.length : parseInt(rowsPerPageValue);
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = rowsPerPageValue === 'all' ? filteredData.length : startIndex + rowsPerPage;
            const currentData = filteredData.slice(startIndex, endIndex);

            tbody.innerHTML = '';

            currentData.forEach((row, index) => {
                const tr = document.createElement('tr');
                const globalIndex = startIndex + index + 1;

                const displayText = (row.text || '').length > 100 ?
                    (row.text || '').substring(0, 100) + '...' : (row.text || '');

                tr.innerHTML = `
                    <td>${globalIndex}</td>
                    <td title="${row.username || ''}">${row.username || 'N/A'}</td>
                    <td class="text-preview" onclick="toggleTextExpansion(this)" title="Click to expand">
                        <div class="text-short">${displayText}</div>
                        <div class="text-full">${row.text || ''}</div>
                    </td>
                    <td class="sentiment-${row.final_sentiment || 'neutral'}">${row.final_sentiment || 'neutral'}</td>
                    <td>${row.combined_sentiment_score ? row.combined_sentiment_score.toFixed(3) : 'N/A'}</td>
                    <td class="confidence-${row.confidence || 'low'}">${row.confidence || 'low'}</td>
                    <td>${row.word_count || 0}</td>
                    <td>${row.emoji_count || 0}</td>
                    <td title="${row.timestamp}">${row.timestamp ? new Date(row.timestamp).toLocaleDateString() : 'N/A'}</td>
                `;

                tbody.appendChild(tr);
            });

            updatePagination();
            document.getElementById('filteredCount').textContent = `${filteredData.length} rows`;
        }

        function updatePagination() {
            const totalRows = filteredData.length;
            const rowsPerPage = rowsPerPageValue === 'all' ? totalRows : parseInt(rowsPerPageValue);
            const totalPages = Math.ceil(totalRows / rowsPerPage);

            document.getElementById('pageInfo').textContent =
                rowsPerPageValue === 'all' ? `Showing all ${totalRows} rows` : `Page ${currentPage} of ${totalPages}`;

            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages || rowsPerPageValue === 'all';
        }

        function changePage(direction) {
            const totalRows = filteredData.length;
            const rowsPerPage = parseInt(rowsPerPageValue);
            const totalPages = Math.ceil(totalRows / rowsPerPage);

            currentPage += direction;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;

            updateTable();
        }

        function updateRowsPerPage() {
            rowsPerPageValue = document.getElementById('rowsPerPage').value;
            currentPage = 1;
            updateTable();
        }

        function toggleTextExpansion(cell) {
            const shortText = cell.querySelector('.text-short');
            const fullText = cell.querySelector('.text-full');

            if (fullText.style.display === 'none' || !fullText.style.display) {
                shortText.style.display = 'none';
                fullText.style.display = 'block';
                cell.title = 'Click to collapse';
            } else {
                shortText.style.display = 'block';
                fullText.style.display = 'none';
                cell.title = 'Click to expand';
            }
        }

        function exportFilteredData() {
            if (filteredData.length === 0) {
                alert('No data to export. Please adjust your filters.');
                return;
            }

            const headers = [
                'Username', 'Text', 'Sentiment', 'Score', 'Confidence',
                'Word_Count', 'Emoji_Count', 'Timestamp'
            ];

            const csvContent = [
                headers.join(','),
                ...filteredData.map(row => [
                    `"${(row.username || '').replace(/"/g, '""')}"`,
                    `"${(row.text || '').replace(/"/g, '""')}"`,
                    row.final_sentiment || 'neutral',
                    row.combined_sentiment_score || '',
                    row.confidence || 'low',
                    row.word_count || 0,
                    row.emoji_count || 0,
                    row.timestamp || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `filtered_data_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.addEventListener('DOMContentLoaded', loadAndAnalyzeData);
    </script>
</body>
</html>