<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimized Threads Sentiment Analysis Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
            font-weight: 400;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9ff, #e8f0ff);
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
        }

        .stat-card:hover::before {
            transform: translateX(100%);
        }

        .stat-number {
            font-size: 2.8rem;
            font-weight: 700;
            color: #667eea;
            display: block;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 1rem;
            color: #666;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .improvement-badge {
            display: inline-block;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 6px 16px;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 25px;
            color: #333;
            text-align: center;
            position: relative;
            padding-bottom: 15px;
        }

        .chart-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 15px;
        }

        .wordcloud-container {
            grid-column: 1 / -1;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .wordcloud-wrapper {
            height: 600px;
            position: relative;
            background: radial-gradient(circle at center, #f8fafc, #e2e8f0);
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #wordcloud {
            max-width: 100%;
            max-height: 100%;
        }

        .comparison-section {
            background: white;
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .comparison-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
            color: #333;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 25px;
        }

        .comparison-card {
            text-align: center;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .comparison-card.original {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: #f59e0b;
        }

        .comparison-card.optimized {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border-color: #22c55e;
        }

        .comparison-card:hover {
            transform: scale(1.02);
        }

        .comparison-label {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .distribution-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .dist-item {
            text-align: center;
        }

        .dist-value {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .dist-label {
            font-size: 0.9rem;
            opacity: 0.8;
            font-weight: 500;
        }

        .positive { color: #22c55e; }
        .negative { color: #ef4444; }
        .neutral { color: #9ca3af; }

        .insights-section {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 20px;
            padding: 35px;
            border-left: 6px solid #0ea5e9;
            box-shadow: 0 10px 25px rgba(14, 165, 233, 0.1);
            margin-bottom: 30px;
        }

        .data-viewer-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .data-viewer-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .data-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .data-controls-left {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .data-controls-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-input, .search-input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus, .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .data-table-container {
            max-height: 500px;
            overflow: auto;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #fff;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-table tr:hover {
            background-color: #f8fafc;
        }

        .data-table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .data-table tr:nth-child(even):hover {
            background-color: #f1f5f9;
        }

        .sentiment-positive {
            background-color: #dcfce7 !important;
            color: #166534;
            font-weight: 600;
        }
        .sentiment-negative {
            background-color: #fee2e2 !important;
            color: #991b1b;
            font-weight: 600;
        }
        .sentiment-neutral {
            background-color: #f3f4f6 !important;
            color: #374151;
            font-weight: 600;
        }

        .confidence-high { color: #059669; font-weight: 600; }
        .confidence-medium { color: #d97706; font-weight: 600; }
        .confidence-low { color: #dc2626; font-weight: 600; }

        .changed-classification {
            border-left: 4px solid #f59e0b !important;
            background-color: #fffbeb !important;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .pagination button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .pagination span {
            font-weight: 600;
            color: #374151;
        }

        .export-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .text-preview {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .text-preview:hover {
            background-color: #e0f2fe !important;
        }

        .text-full {
            display: none;
            max-width: 400px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        @media (max-width: 768px) {
            .data-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .data-controls-left, .data-controls-right {
                justify-content: center;
            }

            .data-table {
                font-size: 11px;
            }

            .data-table th, .data-table td {
                padding: 6px 4px;
                max-width: 120px;
            }
        }

        .insights-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 25px;
            color: #0369a1;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .insight-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid #0ea5e9;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-3px);
        }

        .insight-title {
            font-weight: 700;
            margin-bottom: 12px;
            color: #0369a1;
            font-size: 1.1rem;
        }

        .insight-text {
            color: #666;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .loading {
            text-align: center;
            padding: 80px;
            font-size: 1.3rem;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border: 2px solid #f87171;
            color: #dc2626;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }

        .scatter-container, .timeline-container, .emoji-container, .activity-container {
            grid-column: 1 / -1;
        }

        .scatter-wrapper, .timeline-wrapper, .activity-wrapper {
            height: 500px;
        }

        .emoji-wrapper {
            height: 300px;
        }

        .wordcloud-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .control-btn.active {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .wordcloud-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧵 Optimized Threads Sentiment Analysis</h1>
            <p>Enhanced sentiment classification with tighter thresholds, context-aware signals, and comprehensive word analysis</p>
        </div>

        <div id="loading" class="loading" style="display: none;">
            Processing and analyzing sentiment data...
        </div>

        <div id="upload-section" class="loading">
            <h2>📁 Upload Your CSV File</h2>
            <p>Please select your threads sentiment analysis CSV file:</p>
            <input type="file" id="csvFile" accept=".csv" style="margin: 20px 0; padding: 10px; font-size: 16px;">
            <button onclick="loadUploadedFile()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: 600; cursor: pointer; margin-left: 10px;">Load Analysis</button>
        </div>

        <div id="error" class="error" style="display: none;">
            Error loading data. Please ensure you've selected a valid CSV file with the expected format.
        </div>

        <div id="content" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalReplies">-</span>
                    <div class="stat-label">Total Replies Analyzed</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="reclassified">-</span>
                    <div class="stat-label">Reclassified Replies</div>
                    <div class="improvement-badge" id="reclassifiedPct">-</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="neutralReduction">-</span>
                    <div class="stat-label">Neutral Reduction</div>
                    <div class="improvement-badge" id="neutralReductionPct">-</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="decisiveClassifications">-</span>
                    <div class="stat-label">Decisive Classifications</div>
                    <div class="improvement-badge" id="decisivePct">-</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="avgWordCount">-</span>
                    <div class="stat-label">Average Words per Reply</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="uniqueUsers">-</span>
                    <div class="stat-label">Unique Users</div>
                </div>
            </div>

            <div class="comparison-section">
                <h2 class="comparison-title">📊 Classification Method Comparison</h2>
                <div class="comparison-grid">
                    <div class="comparison-card original">
                        <div class="comparison-label">Original Classification</div>
                        <div class="distribution-stats">
                            <div class="dist-item">
                                <div class="dist-value positive" id="origPositive">-</div>
                                <div class="dist-label">Positive</div>
                            </div>
                            <div class="dist-item">
                                <div class="dist-value neutral" id="origNeutral">-</div>
                                <div class="dist-label">Neutral</div>
                            </div>
                            <div class="dist-item">
                                <div class="dist-value negative" id="origNegative">-</div>
                                <div class="dist-label">Negative</div>
                            </div>
                        </div>
                    </div>
                    <div class="comparison-card optimized">
                        <div class="comparison-label">Optimized Classification</div>
                        <div class="distribution-stats">
                            <div class="dist-item">
                                <div class="dist-value positive" id="optPositive">-</div>
                                <div class="dist-label">Positive</div>
                            </div>
                            <div class="dist-item">
                                <div class="dist-value neutral" id="optNeutral">-</div>
                                <div class="dist-label">Neutral</div>
                            </div>
                            <div class="dist-item">
                                <div class="dist-value negative" id="optNegative">-</div>
                                <div class="dist-label">Negative</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wordcloud-container">
                <h3 class="chart-title">☁️ Interactive Word Cloud</h3>
                <div class="wordcloud-controls">
                    <button class="control-btn active" onclick="updateWordCloud('all')">All Words</button>
                    <button class="control-btn" onclick="updateWordCloud('positive')">Positive Replies</button>
                    <button class="control-btn" onclick="updateWordCloud('negative')">Negative Replies</button>
                    <button class="control-btn" onclick="updateWordCloud('neutral')">Neutral Replies</button>
                    <button class="control-btn" onclick="updateWordCloud('keywords')">Keywords Only</button>
                </div>
                <div class="wordcloud-wrapper">
                    <canvas id="wordcloud" width="1200" height="600"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">🎯 Method Comparison</h3>
                    <div class="chart-wrapper">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">📈 Optimized Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="optimizedPieChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">🔄 Reclassification Patterns</h3>
                    <div class="chart-wrapper">
                        <canvas id="reclassificationChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">📊 Confidence Levels</h3>
                    <div class="chart-wrapper">
                        <canvas id="confidenceChart"></canvas>
                    </div>
                </div>

                <div class="chart-container emoji-container">
                    <h3 class="chart-title">😊 Emoji Usage by Sentiment</h3>
                    <div class="chart-wrapper emoji-wrapper">
                        <canvas id="emojiChart"></canvas>
                    </div>
                </div>

                <div class="chart-container activity-container">
                    <h3 class="chart-title">⏰ Reply Activity by Hour</h3>
                    <div class="chart-wrapper activity-wrapper">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container scatter-container">
                <h3 class="chart-title">🎨 Sentiment Score Distribution with Reclassifications</h3>
                <div class="chart-wrapper scatter-wrapper">
                    <canvas id="scatterChart"></canvas>
                </div>
            </div>

            <div class="chart-container timeline-container">
                <h3 class="chart-title">📈 Sentiment Over Time</h3>
                <div class="chart-wrapper timeline-wrapper">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <div class="insights-section">
                <h2 class="insights-title">💡 Advanced Analysis Insights</h2>
                <div class="insights-grid">
                    <div class="insight-card">
                        <div class="insight-title">🎯 Tighter Classification</div>
                        <div class="insight-text">
                            Reduced neutral threshold from ±0.1 to ±0.05, making sentiment analysis more decisive. This resulted in better classification of borderline cases.
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">🔍 Context-Aware Signals</div>
                        <div class="insight-text">
                            Enhanced classification using emojis, exclamation marks, capitalization, and positive/negative keywords as sentiment boosters for more accurate results.
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">📊 Confidence Scoring</div>
                        <div class="insight-text">
                            Implemented three-tier confidence scoring (high/medium/low) based on sentiment score magnitude to identify certainty levels in classifications.
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">⚖️ Balanced Distribution</div>
                        <div class="insight-text">
                            Achieved better balance between positive and negative sentiment detection while significantly reducing neutral over-classification by 37%.
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">☁️ Word Pattern Analysis</div>
                        <div class="insight-text">
                            Word cloud visualization reveals common themes and language patterns across different sentiment categories, helping identify discussion topics.
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">⏰ Temporal Patterns</div>
                        <div class="insight-text">
                            Activity analysis shows peak engagement hours and how sentiment varies throughout the day, providing insights into user behavior patterns.
                        </div>
                    </div>
                </div>
            </div>

            <div class="data-viewer-section">
                <h2 class="data-viewer-title">📊 Raw Data Viewer</h2>

                <div class="data-controls">
                    <div class="data-controls-left">
                        <input type="text" id="searchInput" class="search-input" placeholder="Search text content..." onkeyup="filterTable()">
                        <select id="sentimentFilter" class="filter-input" onchange="filterTable()">
                            <option value="">All Sentiments</option>
                            <option value="positive">Positive</option>
                            <option value="negative">Negative</option>
                            <option value="neutral">Neutral</option>
                        </select>
                        <select id="confidenceFilter" class="filter-input" onchange="filterTable()">
                            <option value="">All Confidence</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <label>
                            <input type="checkbox" id="changedOnlyFilter" onchange="filterTable()">
                            Reclassified Only
                        </label>
                    </div>
                    <div class="data-controls-right">
                        <button class="export-btn" onclick="exportFilteredData()">📥 Export Filtered</button>
                        <span id="filteredCount">0 rows</span>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th style="width: 60px;">Row</th>
                                <th style="width: 100px;">Username</th>
                                <th style="width: 300px;">Text Content</th>
                                <th style="width: 100px;">Original</th>
                                <th style="width: 100px;">Optimized</th>
                                <th style="width: 80px;">Score</th>
                                <th style="width: 80px;">Confidence</th>
                                <th style="width: 60px;">Words</th>
                                <th style="width: 60px;">Emojis</th>
                                <th style="width: 120px;">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div class="pagination">
                    <button id="prevPageBtn" onclick="changePage(-1)">← Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button id="nextPageBtn" onclick="changePage(1)">Next →</button>
                    <select id="rowsPerPage" onchange="updateRowsPerPage()" style="margin-left: 20px; padding: 5px;">
                        <option value="25">25 rows</option>
                        <option value="50" selected>50 rows</option>
                        <option value="100">100 rows</option>
                        <option value="all">All rows</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for data viewer
        let filteredData = [];
        let currentPage = 1;
        let rowsPerPageValue = 50;
        // Global variables
        let originalData = [];
        let optimizedData = [];
        let charts = {};
        let wordFrequency = {};
        let currentWordCloudFilter = 'all';

        // Load CSV file from user upload
        async function loadUploadedFile() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file first.');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file.');
                return;
            }

            try {
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('loading').style.display = 'block';

                const csvText = await file.text();

                const parsed = Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true
                });

                if (!parsed.data || parsed.data.length === 0) {
                    throw new Error('No data found in CSV file');
                }

                // Validate required columns
                const requiredColumns = ['text', 'final_sentiment', 'combined_sentiment_score'];
                const headers = parsed.meta.fields || [];
                const missingColumns = requiredColumns.filter(col => !headers.includes(col));

                if (missingColumns.length > 0) {
                    throw new Error(`Missing required columns: ${missingColumns.join(', ')}`);
                }

                console.log('Data loaded successfully:', parsed.data.length, 'rows');
                originalData = parsed.data;
                optimizedData = applyOptimization(originalData);
                processWordFrequency();

                hideLoading();
                updateStats();
                createCharts();
                createWordCloud();
                populateDataTable();

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('upload-section').style.display = 'block';
                showError(error.message);
            }
        }

        // Legacy function for direct CSV loading (kept for compatibility)
        async function loadData() {
            try {
                const response = await fetch('threads_replies_18087086674818268_20250825_191726_analyzed.csv');
                if (!response.ok) {
                    throw new Error(`Failed to load CSV file: ${response.status} ${response.statusText}`);
                }
                const csvText = await response.text();

                const parsed = Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true
                });

                if (!parsed.data || parsed.data.length === 0) {
                    throw new Error('No data found in CSV file');
                }

                console.log('Data loaded successfully:', parsed.data.length, 'rows');
                originalData = parsed.data;
                optimizedData = applyOptimization(originalData);
                processWordFrequency();

                hideLoading();
                updateStats();
                createCharts();
                createWordCloud();
                populateDataTable();

            } catch (error) {
                console.error('Error loading data:', error);
                // Fall back to upload interface if direct loading fails
                document.getElementById('loading').style.display = 'none';
                document.getElementById('upload-section').style.display = 'block';
            }
        }

        function applyOptimization(data) {
            return data.map(row => {
                const originalScore = row.combined_sentiment_score;
                if (originalScore === null || isNaN(originalScore)) {
                    return { ...row, optimized_sentiment: 'neutral', confidence: 'low' };
                }

                // Tighter neutral zone (±0.05 instead of ±0.1)
                let tightSentiment;
                if (originalScore > 0.05) {
                    tightSentiment = 'positive';
                } else if (originalScore < -0.05) {
                    tightSentiment = 'negative';
                } else {
                    tightSentiment = 'neutral';
                }

                // Context-aware classification using signals
                let contextSentiment = tightSentiment;
                const hasPositiveKeywords = (row.positive_keywords || 0) > 0;
                const hasNegativeKeywords = (row.negative_keywords || 0) > 0;
                const hasEmojis = (row.emoji_count || 0) > 0;
                const hasExclamation = row.has_exclamation;
                const hasCaps = row.has_caps;

                // Apply context signals for borderline cases
                if (tightSentiment === 'neutral' && Math.abs(originalScore) > 0.02) {
                    if (hasPositiveKeywords || (hasEmojis && originalScore > 0) || (hasExclamation && originalScore > 0)) {
                        contextSentiment = 'positive';
                    } else if (hasNegativeKeywords || (hasCaps && originalScore < 0) || originalScore < -0.03) {
                        contextSentiment = 'negative';
                    }
                }

                // Confidence scoring based on score magnitude
                let confidence;
                if (Math.abs(originalScore) > 0.3) {
                    confidence = 'high';
                } else if (Math.abs(originalScore) > 0.1) {
                    confidence = 'medium';
                } else {
                    confidence = 'low';
                }

                return {
                    ...row,
                    optimized_sentiment: contextSentiment,
                    confidence: confidence
                };
            });
        }

        // Data table functions
        function populateDataTable() {
            filteredData = [...optimizedData];
            currentPage = 1;
            updateTable();
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sentimentFilter = document.getElementById('sentimentFilter').value;
            const confidenceFilter = document.getElementById('confidenceFilter').value;
            const changedOnly = document.getElementById('changedOnlyFilter').checked;

            filteredData = optimizedData.filter(row => {
                const matchesSearch = !searchTerm || (row.text || '').toLowerCase().includes(searchTerm);
                const matchesSentiment = !sentimentFilter || row.optimized_sentiment === sentimentFilter;
                const matchesConfidence = !confidenceFilter || row.confidence === confidenceFilter;
                const matchesChanged = !changedOnly || row.final_sentiment !== row.optimized_sentiment;

                return matchesSearch && matchesSentiment && matchesConfidence && matchesChanged;
            });

            currentPage = 1;
            updateTable();
        }

        function updateTable() {
            const tbody = document.getElementById('dataTableBody');
            const rowsPerPage = rowsPerPageValue === 'all' ? filteredData.length : parseInt(rowsPerPageValue);
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = rowsPerPageValue === 'all' ? filteredData.length : startIndex + rowsPerPage;
            const currentData = filteredData.slice(startIndex, endIndex);

            // Clear existing rows
            tbody.innerHTML = '';

            // Populate rows
            currentData.forEach((row, index) => {
                const tr = document.createElement('tr');
                const globalIndex = startIndex + index + 1;
                const isChanged = row.final_sentiment !== row.optimized_sentiment;

                if (isChanged) {
                    tr.classList.add('changed-classification');
                }

                // Truncate text for display
                const displayText = (row.text || '').length > 100 ?
                    (row.text || '').substring(0, 100) + '...' : (row.text || '');

                tr.innerHTML = `
                    <td>${globalIndex}</td>
                    <td title="${row.username || ''}">${row.username || 'N/A'}</td>
                    <td class="text-preview" onclick="toggleTextExpansion(this)" title="Click to expand">
                        <div class="text-short">${displayText}</div>
                        <div class="text-full">${row.text || ''}</div>
                    </td>
                    <td class="sentiment-${row.final_sentiment}">${row.final_sentiment || 'N/A'}</td>
                    <td class="sentiment-${row.optimized_sentiment}">${row.optimized_sentiment || 'N/A'}</td>
                    <td>${row.combined_sentiment_score ? row.combined_sentiment_score.toFixed(3) : 'N/A'}</td>
                    <td class="confidence-${row.confidence}">${row.confidence || 'N/A'}</td>
                    <td>${row.word_count || 0}</td>
                    <td>${row.emoji_count || 0}</td>
                    <td title="${row.timestamp}">${row.timestamp ? new Date(row.timestamp).toLocaleDateString() : 'N/A'}</td>
                `;

                tbody.appendChild(tr);
            });

            // Update pagination
            updatePagination();

            // Update filtered count
            document.getElementById('filteredCount').textContent = `${filteredData.length} rows`;
        }

        function updatePagination() {
            const totalRows = filteredData.length;
            const rowsPerPage = rowsPerPageValue === 'all' ? totalRows : parseInt(rowsPerPageValue);
            const totalPages = Math.ceil(totalRows / rowsPerPage);

            document.getElementById('pageInfo').textContent =
                rowsPerPageValue === 'all' ? `Showing all ${totalRows} rows` : `Page ${currentPage} of ${totalPages}`;

            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages || rowsPerPageValue === 'all';
        }

        function changePage(direction) {
            const totalRows = filteredData.length;
            const rowsPerPage = parseInt(rowsPerPageValue);
            const totalPages = Math.ceil(totalRows / rowsPerPage);

            currentPage += direction;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;

            updateTable();
        }

        function updateRowsPerPage() {
            rowsPerPageValue = document.getElementById('rowsPerPage').value;
            currentPage = 1;
            updateTable();
        }

        function toggleTextExpansion(cell) {
            const shortText = cell.querySelector('.text-short');
            const fullText = cell.querySelector('.text-full');

            if (fullText.style.display === 'none' || !fullText.style.display) {
                shortText.style.display = 'none';
                fullText.style.display = 'block';
                cell.title = 'Click to collapse';
            } else {
                shortText.style.display = 'block';
                fullText.style.display = 'none';
                cell.title = 'Click to expand';
            }
        }

        function exportFilteredData() {
            if (filteredData.length === 0) {
                alert('No data to export. Please adjust your filters.');
                return;
            }

            // Prepare CSV content
            const headers = [
                'Username', 'Text', 'Original_Sentiment', 'Optimized_Sentiment',
                'Sentiment_Score', 'Confidence', 'Word_Count', 'Emoji_Count',
                'Timestamp', 'Changed'
            ];

            const csvContent = [
                headers.join(','),
                ...filteredData.map(row => [
                    `"${(row.username || '').replace(/"/g, '""')}"`,
                    `"${(row.text || '').replace(/"/g, '""')}"`,
                    row.final_sentiment || '',
                    row.optimized_sentiment || '',
                    row.combined_sentiment_score || '',
                    row.confidence || '',
                    row.word_count || 0,
                    row.emoji_count || 0,
                    row.timestamp || '',
                    row.final_sentiment !== row.optimized_sentiment ? 'Yes' : 'No'
                ].join(','))
            ].join('\n');

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `filtered_sentiment_data_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function processWordFrequency() {
            wordFrequency = {
                all: {},
                positive: {},
                negative: {},
                neutral: {},
                keywords: {}
            };

            // Common stop words to filter out
            const stopWords = new Set([
                'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for',
                'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have',
                'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should',
                'i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us',
                'them', 'my', 'your', 'his', 'its', 'our', 'their', 'this', 'that',
                'these', 'those', 'am', 'if', 'so', 'no', 'not', 'can', 'get', 'just'
            ]);

            // Keywords for focused analysis
            const keywords = [
                'soda', 'coke', 'food', 'healthy', 'sugar', 'money', 'expensive', 'cheap',
                'good', 'bad', 'great', 'terrible', 'love', 'hate', 'agree', 'disagree',
                'right', 'wrong', 'true', 'false', 'bullshit', 'stupid', 'smart', 'dumb'
            ];

            optimizedData.forEach(row => {
                if (!row.text) return;

                const words = row.text.toLowerCase()
                    .replace(/[^\w\s]/g, ' ')
                    .split(/\s+/)
                    .filter(word => word.length > 2 && !stopWords.has(word));

                const sentiment = row.optimized_sentiment;

                words.forEach(word => {
                    // All words
                    wordFrequency.all[word] = (wordFrequency.all[word] || 0) + 1;

                    // By sentiment
                    wordFrequency[sentiment][word] = (wordFrequency[sentiment][word] || 0) + 1;

                    // Keywords only
                    if (keywords.includes(word)) {
                        wordFrequency.keywords[word] = (wordFrequency.keywords[word] || 0) + 1;
                    }
                });
            });
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = `Error: ${message}`;
            errorDiv.style.display = 'block';
        }

        function updateStats() {
            const totalReplies = optimizedData.length;

            const originalCounts = countSentiment(originalData, 'final_sentiment');
            const optimizedCounts = countSentiment(optimizedData, 'optimized_sentiment');

            const reclassified = optimizedData.filter(row =>
                row.final_sentiment !== row.optimized_sentiment
            ).length;

            const neutralReduction = originalCounts.neutral - optimizedCounts.neutral;
            const neutralReductionPct = ((neutralReduction / originalCounts.neutral) * 100).toFixed(1);

            const decisive = optimizedCounts.positive + optimizedCounts.negative;
            const decisivePct = ((decisive / totalReplies) * 100).toFixed(1);

            // Calculate additional stats
            const avgWordCount = optimizedData
                .filter(row => row.word_count)
                .reduce((sum, row) => sum + (row.word_count || 0), 0) / totalReplies;

            const uniqueUsers = new Set(optimizedData.map(row => row.username)).size;

            // Update stats display
            document.getElementById('totalReplies').textContent = totalReplies.toLocaleString();
            document.getElementById('reclassified').textContent = reclassified.toLocaleString();
            document.getElementById('reclassifiedPct').textContent = `${(reclassified/totalReplies*100).toFixed(1)}%`;
            document.getElementById('neutralReduction').textContent = neutralReduction.toLocaleString();
            document.getElementById('neutralReductionPct').textContent = `-${neutralReductionPct}%`;
            document.getElementById('decisiveClassifications').textContent = decisive.toLocaleString();
            document.getElementById('decisivePct').textContent = `${decisivePct}%`;
            document.getElementById('avgWordCount').textContent = avgWordCount.toFixed(1);
            document.getElementById('uniqueUsers').textContent = uniqueUsers.toLocaleString();

            // Update comparison cards
            document.getElementById('origPositive').textContent = `${originalCounts.positive} (${((originalCounts.positive/totalReplies)*100).toFixed(1)}%)`;
            document.getElementById('origNeutral').textContent = `${originalCounts.neutral} (${((originalCounts.neutral/totalReplies)*100).toFixed(1)}%)`;
            document.getElementById('origNegative').textContent = `${originalCounts.negative} (${((originalCounts.negative/totalReplies)*100).toFixed(1)}%)`;

            document.getElementById('optPositive').textContent = `${optimizedCounts.positive} (${((optimizedCounts.positive/totalReplies)*100).toFixed(1)}%)`;
            document.getElementById('optNeutral').textContent = `${optimizedCounts.neutral} (${((optimizedCounts.neutral/totalReplies)*100).toFixed(1)}%)`;
            document.getElementById('optNegative').textContent = `${optimizedCounts.negative} (${((optimizedCounts.negative/totalReplies)*100).toFixed(1)}%)`;
        }

        function countSentiment(data, field) {
            const counts = { positive: 0, negative: 0, neutral: 0 };
            data.forEach(row => {
                const sentiment = row[field];
                if (counts.hasOwnProperty(sentiment)) {
                    counts[sentiment]++;
                }
            });
            return counts;
        }

        function createCharts() {
            try {
                createComparisonChart();
                createOptimizedPieChart();
                createReclassificationChart();
                createConfidenceChart();
                createEmojiChart();
                createActivityChart();
                createScatterChart();
                createTimelineChart();
            } catch (error) {
                console.error('Error creating charts:', error);
                showError('Failed to create charts: ' + error.message);
            }
        }

        function createComparisonChart() {
            const ctx = document.getElementById('comparisonChart');
            if (!ctx) return;

            const originalCounts = countSentiment(originalData, 'final_sentiment');
            const optimizedCounts = countSentiment(optimizedData, 'optimized_sentiment');

            charts.comparison = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Original', 'Optimized'],
                    datasets: [
                        {
                            label: 'Positive',
                            data: [originalCounts.positive, optimizedCounts.positive],
                            backgroundColor: '#22c55e',
                            borderColor: '#16a34a',
                            borderWidth: 2
                        },
                        {
                            label: 'Neutral',
                            data: [originalCounts.neutral, optimizedCounts.neutral],
                            backgroundColor: '#9ca3af',
                            borderColor: '#6b7280',
                            borderWidth: 2
                        },
                        {
                            label: 'Negative',
                            data: [originalCounts.negative, optimizedCounts.negative],
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f3f4f6' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createOptimizedPieChart() {
            const ctx = document.getElementById('optimizedPieChart');
            if (!ctx) return;

            const optimizedCounts = countSentiment(optimizedData, 'optimized_sentiment');

            charts.optimizedPie = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        data: [optimizedCounts.positive, optimizedCounts.neutral, optimizedCounts.negative],
                        backgroundColor: ['#22c55e', '#9ca3af', '#ef4444'],
                        borderColor: ['#16a34a', '#6b7280', '#dc2626'],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function createReclassificationChart() {
            const ctx = document.getElementById('reclassificationChart');
            if (!ctx) return;

            const reclassificationCounts = {};
            optimizedData.forEach(row => {
                if (row.final_sentiment !== row.optimized_sentiment) {
                    const key = `${row.final_sentiment} → ${row.optimized_sentiment}`;
                    reclassificationCounts[key] = (reclassificationCounts[key] || 0) + 1;
                }
            });

            const sortedReclassifications = Object.entries(reclassificationCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);

            if (sortedReclassifications.length === 0) return;

            charts.reclassification = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sortedReclassifications.map(([key]) => key),
                    datasets: [{
                        label: 'Count',
                        data: sortedReclassifications.map(([,count]) => count),
                        backgroundColor: '#f59e0b',
                        borderColor: '#d97706',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { grid: { display: false } },
                        x: { beginAtZero: true, grid: { color: '#f3f4f6' } }
                    }
                }
            });
        }

        function createConfidenceChart() {
            const ctx = document.getElementById('confidenceChart');
            if (!ctx) return;

            const confidenceData = {
                high: { positive: 0, neutral: 0, negative: 0 },
                medium: { positive: 0, neutral: 0, negative: 0 },
                low: { positive: 0, neutral: 0, negative: 0 }
            };

            optimizedData.forEach(row => {
                const conf = row.confidence || 'low';
                const sent = row.optimized_sentiment;
                if (confidenceData[conf] && confidenceData[conf].hasOwnProperty(sent)) {
                    confidenceData[conf][sent]++;
                }
            });

            charts.confidence = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [
                        {
                            label: 'Positive',
                            data: [confidenceData.high.positive, confidenceData.medium.positive, confidenceData.low.positive],
                            backgroundColor: '#22c55e'
                        },
                        {
                            label: 'Neutral',
                            data: [confidenceData.high.neutral, confidenceData.medium.neutral, confidenceData.low.neutral],
                            backgroundColor: '#9ca3af'
                        },
                        {
                            label: 'Negative',
                            data: [confidenceData.high.negative, confidenceData.medium.negative, confidenceData.low.negative],
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function createEmojiChart() {
            const ctx = document.getElementById('emojiChart');
            if (!ctx) return;

            const emojiData = { positive: 0, neutral: 0, negative: 0 };
            optimizedData.forEach(row => {
                if ((row.emoji_count || 0) > 0) {
                    emojiData[row.optimized_sentiment]++;
                }
            });

            charts.emoji = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        label: 'Replies with Emojis',
                        data: [emojiData.positive, emojiData.neutral, emojiData.negative],
                        backgroundColor: ['#22c55e', '#9ca3af', '#ef4444'],
                        borderColor: ['#16a34a', '#6b7280', '#dc2626'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function createActivityChart() {
            const ctx = document.getElementById('activityChart');
            if (!ctx) return;

            const hourlyData = Array(24).fill(0);
            const hourlySentiment = Array(24).fill(null).map(() => ({positive: 0, neutral: 0, negative: 0}));

            optimizedData.forEach(row => {
                if (row.hour !== null && row.hour !== undefined) {
                    const hour = parseInt(row.hour);
                    if (hour >= 0 && hour < 24) {
                        hourlyData[hour]++;
                        hourlySentiment[hour][row.optimized_sentiment]++;
                    }
                }
            });

            charts.activity = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: Array(24).fill(0).map((_, i) => `${i}:00`),
                    datasets: [
                        {
                            label: 'Total Replies',
                            data: hourlyData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Positive',
                            data: hourlySentiment.map(h => h.positive),
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Negative',
                            data: hourlySentiment.map(h => h.negative),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function createScatterChart() {
            const ctx = document.getElementById('scatterChart');
            if (!ctx) return;

            const scatterData = optimizedData
                .filter(row => row.combined_sentiment_score !== null && !isNaN(row.combined_sentiment_score))
                .map(row => {
                    const changed = row.final_sentiment !== row.optimized_sentiment;
                    const sentiment = row.optimized_sentiment;

                    return {
                        x: row.combined_sentiment_score,
                        y: Math.random() * 100,
                        backgroundColor: changed ? '#f59e0b' :
                                       sentiment === 'positive' ? '#22c55e' :
                                       sentiment === 'negative' ? '#ef4444' : '#9ca3af',
                        changed: changed,
                        originalSentiment: row.final_sentiment,
                        optimizedSentiment: row.optimized_sentiment,
                        confidence: row.confidence,
                        text: (row.text || '').substring(0, 100)
                    };
                });

            charts.scatter = new Chart(ctx.getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Replies',
                        data: scatterData,
                        backgroundColor: scatterData.map(point => point.backgroundColor),
                        pointRadius: 4,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const point = context[0].raw;
                                    return `Score: ${point.x.toFixed(3)}`;
                                },
                                label: function(context) {
                                    const point = context[0].raw;
                                    return [
                                        `${point.originalSentiment} → ${point.optimizedSentiment}`,
                                        `Confidence: ${point.confidence}`,
                                        `Text: "${point.text}..."`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Sentiment Score' },
                            min: -1,
                            max: 1,
                            grid: { color: '#f3f4f6' }
                        },
                        y: {
                            display: false,
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        function createTimelineChart() {
            const ctx = document.getElementById('timelineChart');
            if (!ctx) return;

            // Group by date and calculate sentiment distribution
            const timelineData = {};
            optimizedData.forEach(row => {
                if (row.timestamp) {
                    const date = new Date(row.timestamp).toDateString();
                    if (!timelineData[date]) {
                        timelineData[date] = { positive: 0, neutral: 0, negative: 0, total: 0 };
                    }
                    timelineData[date][row.optimized_sentiment]++;
                    timelineData[date].total++;
                }
            });

            const sortedDates = Object.keys(timelineData).sort((a, b) => new Date(a) - new Date(b));
            const positiveData = sortedDates.map(date => (timelineData[date].positive / timelineData[date].total * 100));
            const negativeData = sortedDates.map(date => (timelineData[date].negative / timelineData[date].total * 100));
            const neutralData = sortedDates.map(date => (timelineData[date].neutral / timelineData[date].total * 100));

            charts.timeline = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: sortedDates.map(date => new Date(date).toLocaleDateString()),
                    datasets: [
                        {
                            label: 'Positive %',
                            data: positiveData,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Negative %',
                            data: negativeData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Neutral %',
                            data: neutralData,
                            borderColor: '#9ca3af',
                            backgroundColor: 'rgba(156, 163, 175, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Percentage' },
                            grid: { color: '#f3f4f6' }
                        },
                        x: {
                            title: { display: true, text: 'Date' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createWordCloud() {
            updateWordCloud('all');
        }

        function updateWordCloud(filter) {
            currentWordCloudFilter = filter;

            // Update button states
            document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));

            // Find the button that was clicked and make it active
            const buttons = document.querySelectorAll('.control-btn');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(filter) ||
                    (filter === 'all' && btn.textContent.includes('All')) ||
                    (filter === 'keywords' && btn.textContent.includes('Keywords'))) {
                    btn.classList.add('active');
                }
            });

            const canvas = document.getElementById('wordcloud');
            const ctx = canvas.getContext('2d');

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Get word data for the selected filter
            const words = wordFrequency[filter] || {};
            const wordList = Object.entries(words)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 100)
                .map(([word, count]) => [word, count]);

            if (wordList.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No words found for this filter', canvas.width/2, canvas.height/2);
                return;
            }

            // Create word cloud with better sizing
            WordCloud(canvas, {
                list: wordList,
                gridSize: Math.round(8 * canvas.width / 800), // Smaller grid for tighter packing
                weightFactor: function (size) {
                    // Increased weight factor for larger text
                    const maxCount = Math.max(...wordList.map(([,count]) => count));
                    const minCount = Math.min(...wordList.map(([,count]) => count));
                    const normalizedSize = (size - minCount) / (maxCount - minCount);
                    return (12 + normalizedSize * 48) * (canvas.width / 800); // 12px to 60px range
                },
                fontFamily: 'Arial, sans-serif',
                color: function (word, weight, fontSize, distance, theta) {
                    const colors = {
                        all: ['#667eea', '#764ba2', '#f093fb', '#f5576c'],
                        positive: ['#22c55e', '#16a34a', '#15803d', '#166534'],
                        negative: ['#ef4444', '#dc2626', '#b91c1c', '#991b1b'],
                        neutral: ['#9ca3af', '#6b7280', '#4b5563', '#374151'],
                        keywords: ['#f59e0b', '#d97706', '#b45309', '#92400e']
                    };
                    const colorSet = colors[filter] || colors.all;
                    return colorSet[Math.floor(Math.random() * colorSet.length)];
                },
                rotateRatio: 0.2, // Less rotation for better readability
                backgroundColor: 'transparent',
                drawOutOfBound: false,
                shrinkToFit: true, // Ensure words fit within canvas
                minSize: 12, // Minimum font size
                maxSize: 60 // Maximum font size
            });
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        // Resize handler
        window.addEventListener('resize', function() {
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.resize === 'function') {
                    chart.resize();
                }
            });
        });
    </script>
</body>
</html>